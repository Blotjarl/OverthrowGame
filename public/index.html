<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overthrow Game</title>
</head>
<body>
  <h2>Overthrow Game</h2>

  <div id="lobby">
    <button onclick="createRoom()">Create Room</button>
    
    <h3>Join a Room</h3>
    <input id="nameInput" type="text" placeholder="Enter your name">
    <br><br>
    <input id="roomInput" type="text" placeholder="Enter room code">
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <div id="room" style="display: none;">
    <p id="roomDisplay"></p>
    <ul id="players"></ul>
    <div id="start-game-container"></div> 
    <button onclick="leaveRoom()">Leave Room</button>
  </div>

  <div id="game-container" style="display: none;">
    <h3>Game Board</h3>
    <div id="opponents-area"></div>
    <hr>
    <div id="player-area"></div>
    <div id="action-menu"></div>
    <hr>
    <h4>Action Log</h4>
    <div id="action-log"></div>
  </div>

  <p id="status"></p>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null;
    let gameState = null; // Variable to hold the current game state
    let selectedCards = [];
    let selectingTargetFor = null;

    socket.on('gameUpdate', (newGameState) => {
      console.log('Received game update:', newGameState);
      gameState = newGameState; // Overwrite the old state with the new one
      renderGameState(); // Redraw the entire game board
    });

    socket.on('gameStarted', (initialGameState) => {
      console.log('Game is starting!', initialGameState);
      gameState = initialGameState;

      // Hide lobby and room divs
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('room').style.display = 'none';
      
      // Show the game container
      document.getElementById('game-container').style.display = 'block';

      renderGameState();
    });

    function revealCard(cardName) {
      console.log(`Revealing card: ${cardName}`);
      socket.emit('revealCard', { roomId: currentRoom, cardName: cardName });
    }

    function respondToAction(response) {
      console.log(`Responding to action with: ${response}`);
      socket.emit('challengeResponse', { roomId: currentRoom, response: response });
    }

    function cancelTargetSelection() {
      selectingTargetFor = null;
      renderGameState();
    }

    function declareBlock(blockType) {
      console.log(`Declaring block with: ${blockType}`);
      socket.emit('declareBlock', { roomId: currentRoom, blockType: blockType });
    }

    function respondToForeignAid(response) {
      console.log(`Responding to Foreign Aid with: ${response}`);
      socket.emit('foreignAidResponse', { roomId: currentRoom, response: response });
    }

    function respondToBlock(response) {
      console.log(`Responding to block with: ${response}`);
      // Emit a new event specifically for block responses
      socket.emit('blockResponse', { roomId: currentRoom, response: response });
    }

    function initiateTargetedAction(action) {
      selectingTargetFor = action; // Set the state to 'steal' or 'assassinate'
      renderGameState(); // Re-draw the UI to show the target list
    }

    // This function redraws the entire game UI based on the current gameState
    function renderGameState() {
      if (!gameState) return;

      const opponentsArea = document.getElementById('opponents-area');
      const playerArea = document.getElementById('player-area');
      const actionMenu = document.getElementById('action-menu');
      const actionLog = document.getElementById('action-log');

      // Clear previous state
      opponentsArea.innerHTML = '<h4>Opponents</h4>';
      playerArea.innerHTML = '';
      actionMenu.innerHTML = '';

      // Find the current player's data
      const me = gameState.players.find(p => p.id === socket.id);
      const currentPlayer = gameState.players[gameState.currentPlayerIndex];
      const myTurn = currentPlayer.id === socket.id;

      // Render other players
      gameState.players.forEach(player => {
        if (player.id === socket.id) return; // Don't render myself here

        const opponentDiv = document.createElement('div');
        const isTheirTurn = gameState.players[gameState.currentPlayerIndex].id === player.id;
        opponentDiv.innerHTML = `
          <strong>${player.name} ${isTheirTurn ? ' (Turn)' : ''}</strong><br>
          Coins: ${player.coins}<br>
          Cards: ${player.cards.length}
        `;
        opponentsArea.appendChild(opponentDiv);
      });

      // Render my own area
      if (me) {
        playerArea.innerHTML = `
          <h4>Your Hand (${me.name})</h4>
          <p><strong>My Coins:</strong> ${me.coins}</p>
          <p><strong>My Cards:</strong> ${me.cards.join(', ')}</p>
        `;
      }
      
      // Render action buttons if it's my turn
      switch (gameState.phase) {
        case 'action':
          if (myTurn) {
            // If we are currently selecting a target for an action...
            if (selectingTargetFor) {
              actionMenu.innerHTML = `<h4>Who do you want to ${selectingTargetFor}?</h4>`;
              gameState.players.forEach(target => {
                if (target.id !== socket.id && target.isAlive) {
                  // Pass both the action and the target's ID
                  actionMenu.innerHTML += `<button onclick="performAction('${selectingTargetFor}', '${target.id}')">${target.name}</button>`;
                }
              });
              // Add a cancel button
              actionMenu.innerHTML += `<button onclick="cancelTargetSelection()">Cancel</button>`;
            } 
            // Otherwise, show the normal list of actions
            else {
              let actionsHtml = `
                <h4>Your Actions</h4>
                <button onclick="performAction('income')">Income</button>
                <button onclick="performAction('foreign_aid')">Foreign Aid</button>
                <button onclick="performAction('tax')">Tax (Duke)</button>
                <!-- These now call the new function -->
                <button onclick="initiateTargetedAction('steal')">Steal (Captain)</button>
              `;
              if (me.coins >= 3) {
                actionsHtml += `<button onclick="initiateTargetedAction('assassinate')">Assassinate (Assassin)</button>`;
              }
              if (me.coins >= 7) {
                actionsHtml += `<button onclick="initiateTargetedAction('coup')">Coup</button>`;
              }
              actionMenu.innerHTML = actionsHtml;
            }
          }
          break;
    
        case 'challenge':
          case 'challenge':
          const actor = gameState.players.find(p => p.id === gameState.pendingAction.actorId);
          actionMenu.innerHTML = `<h4>${actor.name} is attempting to use ${gameState.pendingAction.action}!</h4>`;

          // Show Challenge/Pass to everyone who is alive and NOT the person who took the action
          if (actor.id !== socket.id && me.isAlive) {
              actionMenu.innerHTML += `
                  <button onclick="respondToAction('challenge')">Challenge</button>
                  <button onclick="respondToAction('pass')">Pass</button>
              `;
          }
          break;

        case 'declare_block':
          const actionInfo = gameState.pendingAction;
          const target = gameState.players.find(p => p.id === actionInfo.targetId);
          actionMenu.innerHTML = `<h4>Waiting for ${target.name} to respond to the ${actionInfo.action}...</h4>`;

          // If YOU are the target of the action, show the block options
          if (actionInfo.targetId === socket.id) {
              let blockButtons = `<h4>Do you want to block the ${actionInfo.action}?</h4>`;
              if (actionInfo.action.toLowerCase() === 'steal') {
                  blockButtons += `
                      <button onclick="declareBlock('Captain')">Block with Captain</button>
                      <button onclick="declareBlock('Ambassador')">Block with Ambassador</button>
                  `;
              }
              // We can add 'assassinate' logic here later
              blockButtons += `<button onclick="declareBlock('No Block')">Do Not Block</button>`;
              actionMenu.innerHTML = blockButtons;
          }
          break;  

        case 'block_declaration_period':
            const foreignAidActor = gameState.players.find(p => p.id === gameState.pendingAction.actorId);
            actionMenu.innerHTML = `<h4>${foreignAidActor.name} is taking Foreign Aid!</h4>`;

            // Show block/pass buttons to everyone who is alive and NOT the one taking the action
            if (foreignAidActor.id !== socket.id && me.isAlive) {
                actionMenu.innerHTML += `
                    <button onclick="respondToForeignAid('block')">Block with Duke</button>
                    <button onclick="respondToForeignAid('pass')">Pass</button>
                `;
            }
            break;

        case 'block_challenge':
          const blocker = gameState.players.find(p => p.id === gameState.pendingBlock.blockerId);
          const blockingCard = gameState.pendingBlock.blockingCard;

          actionMenu.innerHTML = `<h4>${blocker.name} is attempting to BLOCK with a ${blockingCard}!</h4>`;

          // Show challenge/pass buttons to everyone who is alive and NOT the one blocking
          if (blocker.id !== socket.id && me.isAlive) {
            actionMenu.innerHTML += `
              <button onclick="respondToBlock('challenge')">Challenge Block</button>
              <button onclick="respondToBlock('pass')">Pass</button>
            `;
          }
          break;

        case 'exchange_cards':
          actionMenu.innerHTML = `<h4>Waiting for ${gameState.players.find(p => p.id === gameState.exchangeInfo.playerId).name} to exchange...</h4>`;

          // If it's ME who is exchanging...
          if (gameState.exchangeInfo.playerId === socket.id) {
            actionMenu.innerHTML = `
              <h4>You drew two cards. Choose which two to KEEP.</h4>
              <div id="exchange-options"></div>
            `;
            const optionsContainer = document.getElementById('exchange-options');
            gameState.exchangeInfo.options.forEach(card => {
              optionsContainer.innerHTML += `<button onclick="selectExchangeCard('${card}')">${card}</button>`;
            });
          }
          break;
        
        case 'reveal_card':
          const playerToReveal = gameState.players.find(p => p.id === gameState.playerToReveal.id);
          actionMenu.innerHTML = `<h4>Waiting for ${playerToReveal.name} to reveal a card...</h4>`;

          // If it's ME who has to reveal...
          if (gameState.playerToReveal.id === socket.id) {
            actionMenu.innerHTML = `
              <h4>You lost the challenge. Choose a card to reveal:</h4>
              <button onclick="revealCard('${me.cards[0]}')">${me.cards[0]}</button>
              ${me.cards[1] ? `<button onclick="revealCard('${me.cards[1]}')">${me.cards[1]}</button>` : ''}
            `;
          }
          break;
        case 'game_over':
          actionMenu.innerHTML = `<h2>Game Over</h2>`;
          break;
      }

      // Render action log
      actionLog.innerHTML = gameState.actionLog.join('<br>');
    }

    function performAction(action, targetId = null) {
      console.log(`Attempting to perform action: ${action}`, targetId ? `on target ${targetId}` : '');
      socket.emit('performAction', { roomId: currentRoom, action, targetId });

      // Reset the targeting state after performing the action
      selectingTargetFor = null; 
    }

    // Handle starting the game
    function startGame() {
      console.log('Starting game in room:', currentRoom);
      socket.emit('startGame', currentRoom);
    }

    // On connect
    socket.on('connect', () => {
      document.getElementById('status').innerText = `Connected! Your ID: ${socket.id}`;
    });

    // Create room
    function createRoom() {
      const username = document.getElementById('nameInput').value.trim();
      if (username) {
        socket.emit('createRoom', { username });
    } else {
        alert('Please enter a name!');
      }
    }

    // Join room
    function joinRoom() {
      const username = document.getElementById('nameInput').value.trim();
      const roomId = document.getElementById('roomInput').value.trim();
      if (username && roomId) {
        socket.emit('joinRoom', { roomId, username });
      } else {
        alert('Please enter your name and a room code!');
      }
    }

    // Leave room
    function leaveRoom() {
      socket.emit('leaveRoom', currentRoom);
      currentRoom = null;
      document.getElementById('room').style.display = 'none';
      document.getElementById('lobby').style.display = 'block';
    }

    // Server sends new room ID
    socket.on('roomCreated', (roomId) => {
      currentRoom = roomId;
      showRoom(roomId);
    });

    // Update room player list
    socket.on('roomUpdate', (room) => { // 'room' is now an object { hostId, players }
      if (!currentRoom) {
        const roomId = document.getElementById('roomInput').value.trim();
        showRoom(roomId);
      }

      // Update player list (now using room.players)
      const list = document.getElementById('players');
      list.innerHTML = '';
      room.players.forEach((player) => {
        const li = document.createElement('li');
        li.textContent = player.name;
        if (player.id === socket.id) {
            li.textContent += ' (You)';
            li.style.fontWeight = 'bold';
        }
        list.appendChild(li);
      });

      // Logic to show/hide the "Start Game" button
      const startButtonContainer = document.getElementById('start-game-container');
      // For a 2+ player game
      if (room.hostId === socket.id && room.players.length >= 2) {
        startButtonContainer.innerHTML = '<button onclick="startGame()">Start Game</button>';
      } else {
        startButtonContainer.innerHTML = ''; // Clear the button if conditions aren't met
      }
    });

    // Show error messages
    socket.on('errorMessage', (msg) => {
      alert(msg);
    });

    // Helper to display room UI
    function showRoom(roomId) {
      currentRoom = roomId;
      document.getElementById('roomDisplay').innerText = `You are in Room: ${roomId}`;
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('room').style.display = 'block';
    }

    function selectExchangeCard(cardName) {
      // Add card to selection
      selectedCards.push(cardName);

      // Once two cards are selected, send them to the server
      if (selectedCards.length === 2) {
        socket.emit('returnExchangeCards', { roomId: currentRoom, keptCards: selectedCards });
        selectedCards = []; // Reset for next time
      }
}
  </script>

</body>
</html>
